/**
 * File ch√≠nh c·ªßa ·ª©ng d·ª•ng Backend Node.js
 * Kh·ªüi t·∫°o server Express v·ªõi t·∫•t c·∫£ middleware v√† routes
 */

require("dotenv").config();
const express = require("express");
const mongoose = require("mongoose");
const path = require("path");
const http = require("http");

// Import c√°c modules
const { connectDB } = require("./config/database");

// Import controllers
const authController = require("./controllers/authController");
const userController = require("./controllers/userController");
const chatController = require("./controllers/chatController");

// Import middlewares
const { authVerifyToken } = require("./middlewares/authVerifyToken");
const { authCheckAdmin } = require("./middlewares/authCheckAdmin");
const { authCheckUser } = require("./middlewares/authCheckUser");
const { authValidateSession } = require("./middlewares/authValidateSession");
const {
  authLoginLimiter,
  authRegisterLimiter,
  authApiLimiter,
} = require("./middlewares/authRateLimit");
const {
  authLogLogin,
  authLogLogout,
} = require("./middlewares/authLogActivity");
const {
  securityHelmet,
  addSecurityHeaders,
} = require("./middlewares/securityHelmet");
const { securityCors } = require("./middlewares/securityCors");
const {
  csrfProtection,
  csrfCookieGenerator,
  csrfTokenGenerator,
} = require("./middlewares/securityCsrf");
const { sanitizeInput } = require("./middlewares/securitySanitize");
const { securityRateLimit } = require("./middlewares/securityRateLimit");
const {
  loggingRequestBasic,
  loggingRequestDetailed,
} = require("./middlewares/loggingRequest");
const {
  errorHandlerGlobal,
  errorHandlerValidation,
  errorHandlerAuth,
  errorHandler404,
} = require("./middlewares/errorHandler");
const { loggingActivityCrud } = require("./middlewares/loggingActivity");

// Import chat security middlewares
const {
  chatRateLimit,
  chatSessionValidation,
  chatPrivacyProtection,
  chatContentFiltering,
  chatFloodPrevention,
  chatAuditLogging,
  chatResourceLimits,
  chatIPBlacklist,
  chatRequestValidation,
  chatPerformanceMonitoring,
} = require("./middlewares/chatSecurity");

// Import chat optimization middlewares
const {
  chatCompression,
  chatCache,
  chatConnectionPool,
  chatMemoryManager,
  chatRequestBatching,
  chatSecurityHeaders,
  chatHealthCheck,
  chatRequestDeduplication,
  chatResponseOptimization,
  chatCircuitBreaker,
} = require("./middlewares/chatOptimizations");

// Import web tracking middlewares
const {
  trackUserActivity,
  trackGPSLocation,
  trackDeviceInfo,
  trackSession,
  getTrackingStats,
  exportTrackingData,
} = require("./middlewares/webTracking");

// Kh·ªüi t·∫°o Express app
const app = express();
const server = http.createServer(app);

// C·∫•u h√¨nh c∆° b·∫£n
const PORT = process.env.PORT || 3000;
const NODE_ENV = process.env.NODE_ENV || "development";

// Trust proxy (quan tr·ªçng cho rate limiting khi deploy)
app.set("trust proxy", 1);

// C·∫•u h√¨nh EJS view engine
app.set("view engine", "ejs");
app.set("views", path.join(__dirname, "views"));

// =====================================================================================
// MIDDLEWARE C∆† B·∫¢N
// =====================================================================================

// Security headers (ƒë·∫∑t ƒë·∫ßu ti√™n)
app.use(securityHelmet);
app.use(addSecurityHeaders);

// CORS
app.use(securityCors);

// Rate limiting t·ªïng th·ªÉ
app.use(securityRateLimit);

// Logging requests
if (NODE_ENV === "development") {
  app.use(loggingRequestDetailed);
} else {
  app.use(loggingRequestBasic);
}

// Body parsing middleware
app.use(express.json({ limit: "10mb" }));
app.use(express.urlencoded({ extended: true, limit: "10mb" }));

// Cookie parser
const cookieParser = require("cookie-parser");
app.use(cookieParser());

// Static files
app.use(express.static(path.join(__dirname, "public")));
app.use("/client", express.static(path.join(__dirname, "client")));

// Input sanitization
app.use(sanitizeInput);

// =====================================================================================
// WEB TRACKING MIDDLEWARE (ƒë·∫∑t sau body parsing, tr∆∞·ªõc auth)
// =====================================================================================

// Track m·ªçi ho·∫°t ƒë·ªông c·ªßa user tr√™n web
app.use(trackUserActivity);

// =====================================================================================
// SESSION & CSRF (n·∫øu s·ª≠ d·ª•ng session)
// =====================================================================================

// CSRF protection (ch·ªâ cho routes c·∫ßn thi·∫øt)
app.use("/api", csrfProtection);

// =====================================================================================
// SECURITY MIDDLEWARE
// =====================================================================================

// B·∫£o v·ªá t·∫•t c·∫£ routes v·ªõi rate limiting
app.use("/api", authApiLimiter);

// =====================================================================================
// LOGGING MIDDLEWARE
// =====================================================================================

// Activity logging cho CRUD operations
app.use("/api/v1/user", loggingActivityCrud);

// =====================================================================================
// PUBLIC ROUTES (kh√¥ng c·∫ßn auth)
// =====================================================================================

// Trang login
app.get("/login", authController.showLoginPage);

// X·ª≠ l√Ω login
app.post(
  "/login",
  authLoginLimiter,
  authLogLogin,
  require("./validations/expressValidators").commonValidators.login,
  authController.login
);

// API ƒëƒÉng k√Ω (sign in)
app.post(
  "/api/v1/signIn",
  authRegisterLimiter,
  require("./validations/expressValidators").createNewUserValidators.register,
  // TODO: Implement sign in controller
  (req, res) => res.json({ message: "Sign in endpoint - TODO" })
);

// =====================================================================================
// WEB TRACKING API ROUTES
// =====================================================================================

// Track GPS location
app.post("/api/track-location", authCheckUser, trackGPSLocation);

// Track device and network info
app.post("/api/track-device-info", authCheckUser, trackDeviceInfo);

// Track session info
app.post("/api/track-session", authCheckUser, trackSession);

// Get tracking statistics (admin only)
app.get("/api/tracking/stats", authCheckAdmin, getTrackingStats);

// Export tracking data (admin only)
app.get("/api/tracking/export", authCheckAdmin, exportTrackingData);

// =====================================================================================
// AUTHENTICATED ROUTES (c·∫ßn login)
// =====================================================================================

// Middleware x√°c th·ª±c token cho t·∫•t c·∫£ routes c√≤n l·∫°i
app.use(authVerifyToken);

// Validate session
app.use(authValidateSession);

// Logout
app.post("/logout", authLogLogout, authController.logout);

// Check auth status
app.get("/auth/status", authController.checkAuthStatus);

// Refresh token
app.post("/auth/refresh", authController.refreshToken);

// Verify token endpoint
app.get("/api/v1/verify-token", authController.checkAuthStatus);
// Get profile
app.get("/auth/profile", authController.getProfile);

// =====================================================================================
// USER MANAGEMENT ROUTES
// =====================================================================================

// Dashboard - ch·ªâ admin m·ªõi xem ƒë∆∞·ª£c t·∫•t c·∫£ users
app.get(
  "/dashboard",
  authCheckAdmin,
  // TODO: Implement dashboard controller
  (req, res) =>
    res.render("dashboard", {
      title: "Dashboard",
      currentUser: req.user,
      stats: {}, // TODO: Add real stats
    })
);

// User routes v·ªõi ph√¢n quy·ªÅn
app.get("/api/v1/user", authCheckUser, userController.getUserAll);

app.get("/api/v1/user/new", authCheckAdmin, userController.showCreateUserForm);

app.post(
  "/api/v1/user",
  authCheckAdmin,
  require("./validations/expressValidators").userValidators.createUser,
  userController.createUserNew
);

app.get(
  "/api/v1/user/:id",
  authCheckUser,
  require("./validations/expressValidators").userValidators.getUserById,
  userController.getUserForID
);

app.get(
  "/api/v1/user/:id/edit",
  authCheckUser,
  require("./validations/expressValidators").userValidators.getUserById,
  userController.showEditUserForm
);

app.put(
  "/api/v1/user/:id",
  authCheckUser,
  require("./validations/expressValidators").userValidators.updateUser,
  userController.updateForID
);

app.delete(
  "/api/v1/user/:id",
  authCheckAdmin,
  require("./validations/expressValidators").userValidators.deleteUser,
  userController.deleteForID
);

// =====================================================================================
// CHAT ROUTES - Protected by 10 specialized security middlewares
// =====================================================================================

// Add optimization middlewares globally for chat routes
app.use("/chat", chatCompression);
app.use("/chat", chatCache.middleware);
app.use("/chat", chatConnectionPool.middleware);
app.use("/chat", chatMemoryManager.monitor);
app.use("/chat", chatSecurityHeaders);
app.use("/chat", chatRequestDeduplication);
app.use("/chat", chatResponseOptimization);
app.use("/chat", chatCircuitBreaker.middleware);

// Health check endpoint
app.get("/chat/health", chatHealthCheck);

// Chat register
app.post(
  "/chat/register",
  // üîí Security Layer: Rate limiting, IP blacklist, flood prevention
  chatIPBlacklist,
  chatRateLimit,
  chatFloodPrevention,
  // ‚úÖ Session & Auth: Validate user session and chat registration
  authCheckUser,
  chatSessionValidation,
  // üõ°Ô∏è Content & Privacy: Filter content, validate requests
  chatRequestValidation,
  chatContentFiltering,
  // üìä Monitoring: Audit logging and performance monitoring
  chatAuditLogging,
  chatPerformanceMonitoring,
  // üéØ Validation: Express validators for chat data
  require("./validations/expressValidators").chatValidators.registerChat,
  chatController.registerChat
);

// Chat messages routes - s·ª≠a l·ªói typing
app.post(
  "/chat/messages/private",
  // üîí Security Layer: Rate limiting, flood prevention
  chatIPBlacklist,
  chatRateLimit,
  chatFloodPrevention,
  // ‚úÖ Session & Auth: Validate user session
  authCheckUser,
  chatSessionValidation,
  // üõ°Ô∏è Content & Resources: Filter content, limit resources
  chatRequestValidation,
  chatContentFiltering,
  chatResourceLimits,
  // üìä Monitoring: Audit logging and performance
  chatAuditLogging,
  chatPerformanceMonitoring,
  // üéØ Validation: Express validators
  require("./validations/expressValidators").chatValidators.sendPrivateMessage,
  chatController.sendPrivateMessage
);

app.post(
  "/chat/messages/group",
  // üîí Security Layer: Rate limiting, flood prevention
  chatIPBlacklist,
  chatRateLimit,
  chatFloodPrevention,
  // ‚úÖ Session & Auth: Validate user session
  authCheckUser,
  chatSessionValidation,
  // üõ°Ô∏è Content & Resources: Filter content, limit resources
  chatRequestValidation,
  chatContentFiltering,
  chatResourceLimits,
  // üìä Monitoring: Audit logging and performance
  chatAuditLogging,
  chatPerformanceMonitoring,
  // üéØ Validation: Express validators
  require("./validations/expressValidators").chatValidators.sendGroupMessage,
  chatController.sendGroupMessage
);

app.get(
  "/chat/messages/private/:userId",
  // üîí Security Layer: Rate limiting
  chatIPBlacklist,
  chatRateLimit,
  // ‚úÖ Session & Auth: Validate user session
  authCheckUser,
  chatSessionValidation,
  // üõ°Ô∏è Privacy Protection: Check access permissions
  chatPrivacyProtection,
  // üìä Monitoring: Audit logging and performance
  chatAuditLogging,
  chatPerformanceMonitoring,
  // üéØ Validation: Request validation
  chatRequestValidation,
  chatController.getPrivateMessages
);

app.get(
  "/chat/messages/group/:groupId",
  // üîí Security Layer: Rate limiting
  chatIPBlacklist,
  chatRateLimit,
  // ‚úÖ Session & Auth: Validate user session
  authCheckUser,
  chatSessionValidation,
  // üõ°Ô∏è Privacy Protection: Check access permissions
  chatPrivacyProtection,
  // üìä Monitoring: Audit logging and performance
  chatAuditLogging,
  chatPerformanceMonitoring,
  // üéØ Validation: Request validation
  chatRequestValidation,
  chatController.getGroupMessages
);

// Chat groups routes
app.post(
  "/chat/groups",
  // üîí Security Layer: Rate limiting, flood prevention
  chatIPBlacklist,
  chatRateLimit,
  chatFloodPrevention,
  // ‚úÖ Session & Auth: Validate user session
  authCheckUser,
  chatSessionValidation,
  // üõ°Ô∏è Resources: Limit resource usage
  chatResourceLimits,
  // üìä Monitoring: Audit logging and performance
  chatAuditLogging,
  chatPerformanceMonitoring,
  // üéØ Validation: Request validation
  chatRequestValidation,
  chatController.createGroup
);

app.get(
  "/chat/groups/:groupId",
  // üîí Security Layer: Rate limiting
  chatIPBlacklist,
  chatRateLimit,
  // ‚úÖ Session & Auth: Validate user session
  authCheckUser,
  chatSessionValidation,
  // üõ°Ô∏è Privacy Protection: Check access permissions
  chatPrivacyProtection,
  // üìä Monitoring: Audit logging and performance
  chatAuditLogging,
  chatPerformanceMonitoring,
  // üéØ Validation: Request validation
  chatRequestValidation,
  chatController.getGroupById
);

app.put(
  "/chat/groups/:groupId",
  // üîí Security Layer: Rate limiting, flood prevention
  chatIPBlacklist,
  chatRateLimit,
  chatFloodPrevention,
  // ‚úÖ Session & Auth: Validate user session
  authCheckUser,
  chatSessionValidation,
  // üõ°Ô∏è Content & Resources: Filter content, limit resources
  chatRequestValidation,
  chatContentFiltering,
  chatResourceLimits,
  // üìä Monitoring: Audit logging and performance
  chatAuditLogging,
  chatPerformanceMonitoring,
  // üéØ Validation: Express validators
  require("./validations/expressValidators").chatValidators.updateGroup,
  chatController.updateGroup
);

app.post(
  "/chat/groups/:groupId/members",
  // üîí Security Layer: Rate limiting, flood prevention
  chatIPBlacklist,
  chatRateLimit,
  chatFloodPrevention,
  // ‚úÖ Session & Auth: Validate user session
  authCheckUser,
  chatSessionValidation,
  // üõ°Ô∏è Resources: Limit member additions
  chatResourceLimits,
  // üìä Monitoring: Audit logging and performance
  chatAuditLogging,
  chatPerformanceMonitoring,
  // üéØ Validation: Request validation
  chatRequestValidation,
  chatController.addGroupMember
);

app.delete(
  "/chat/groups/:groupId/members/:userId",
  // üîí Security Layer: Rate limiting
  chatIPBlacklist,
  chatRateLimit,
  // ‚úÖ Session & Auth: Validate user session
  authCheckUser,
  chatSessionValidation,
  // üìä Monitoring: Audit logging and performance
  chatAuditLogging,
  chatPerformanceMonitoring,
  // üéØ Validation: Request validation
  chatRequestValidation,
  chatController.removeGroupMember
);

app.get(
  "/chat/groups",
  // üîí Security Layer: Rate limiting
  chatIPBlacklist,
  chatRateLimit,
  // ‚úÖ Session & Auth: Validate user session
  authCheckUser,
  chatSessionValidation,
  // üìä Monitoring: Audit logging and performance
  chatAuditLogging,
  chatPerformanceMonitoring,
  chatController.getUserGroups
);

// Chat reactions routes
app.post(
  "/chat/messages/:messageId/reactions",
  // üîí Security Layer: Rate limiting, flood prevention
  chatIPBlacklist,
  chatRateLimit,
  chatFloodPrevention,
  // ‚úÖ Session & Auth: Validate user session
  authCheckUser,
  chatSessionValidation,
  // üõ°Ô∏è Resources: Limit reactions
  chatResourceLimits,
  // üìä Monitoring: Audit logging and performance
  chatAuditLogging,
  chatPerformanceMonitoring,
  // üéØ Validation: Request validation
  chatRequestValidation,
  chatController.addMessageReaction
);

app.delete(
  "/chat/messages/:messageId/reactions",
  // üîí Security Layer: Rate limiting
  chatIPBlacklist,
  chatRateLimit,
  // ‚úÖ Session & Auth: Validate user session
  authCheckUser,
  chatSessionValidation,
  // üìä Monitoring: Audit logging and performance
  chatAuditLogging,
  chatPerformanceMonitoring,
  // üéØ Validation: Request validation
  chatRequestValidation,
  chatController.removeMessageReaction
);

app.put(
  "/chat/messages/:messageId/read",
  // üîí Security Layer: Rate limiting
  chatIPBlacklist,
  chatRateLimit,
  // ‚úÖ Session & Auth: Validate user session
  authCheckUser,
  chatSessionValidation,
  // üìä Monitoring: Audit logging and performance
  chatAuditLogging,
  chatPerformanceMonitoring,
  // üéØ Validation: Request validation
  chatRequestValidation,
  chatController.markMessageAsRead
);

app.delete(
  "/chat/messages/:messageId",
  // üîí Security Layer: Rate limiting
  chatIPBlacklist,
  chatRateLimit,
  // ‚úÖ Session & Auth: Validate user session
  authCheckUser,
  chatSessionValidation,
  // üìä Monitoring: Audit logging and performance
  chatAuditLogging,
  chatPerformanceMonitoring,
  // üéØ Validation: Request validation
  chatRequestValidation,
  chatController.deleteMessage
);

app.get(
  "/chat/messages/search",
  // üîí Security Layer: Rate limiting, flood prevention
  chatIPBlacklist,
  chatRateLimit,
  chatFloodPrevention,
  // ‚úÖ Session & Auth: Validate user session
  authCheckUser,
  chatSessionValidation,
  // üìä Monitoring: Audit logging and performance
  chatAuditLogging,
  chatPerformanceMonitoring,
  // üéØ Validation: Request validation
  chatRequestValidation,
  chatController.searchMessages
);

// Chat user management
app.get(
  "/chat/user/:id",
  // üîí Security Layer: Rate limiting, IP blacklist
  chatIPBlacklist,
  chatRateLimit,
  // ‚úÖ Session & Auth: Validate user session
  authCheckUser,
  chatSessionValidation,
  // üõ°Ô∏è Privacy Protection: Check access permissions
  chatPrivacyProtection,
  // üìä Monitoring: Audit logging and performance
  chatAuditLogging,
  chatPerformanceMonitoring,
  // üéØ Validation: Request validation
  chatRequestValidation,
  chatController.getChatUserById
);

app.put(
  "/chat/user/:id",
  // üîí Security Layer: Rate limiting, flood prevention
  chatIPBlacklist,
  chatRateLimit,
  chatFloodPrevention,
  // ‚úÖ Session & Auth: Validate user session
  authCheckUser,
  chatSessionValidation,
  // üõ°Ô∏è Content & Resources: Filter content, limit resources
  chatRequestValidation,
  chatContentFiltering,
  chatResourceLimits,
  // üìä Monitoring: Audit logging and performance
  chatAuditLogging,
  chatPerformanceMonitoring,
  // üéØ Validation: Express validators
  require("./validations/expressValidators").chatValidators.updateChatUser,
  chatController.updateChatUser
);

app.delete(
  "/chat/user/:id",
  // üîí Security Layer: Rate limiting
  chatIPBlacklist,
  chatRateLimit,
  // ‚úÖ Session & Auth: Validate admin session
  authCheckAdmin,
  chatSessionValidation,
  // üìä Monitoring: Audit logging and performance
  chatAuditLogging,
  chatPerformanceMonitoring,
  // üéØ Validation: Request validation
  chatRequestValidation,
  chatController.deleteChatUser
);

// Chat friends management
app.post(
  "/chat/user/:id/friend/:friendId",
  // üîí Security Layer: Rate limiting, flood prevention
  chatIPBlacklist,
  chatRateLimit,
  chatFloodPrevention,
  // ‚úÖ Session & Auth: Validate user session
  authCheckUser,
  chatSessionValidation,
  // üõ°Ô∏è Resources: Limit friend additions
  chatResourceLimits,
  // üìä Monitoring: Audit logging and performance
  chatAuditLogging,
  chatPerformanceMonitoring,
  // üéØ Validation: Request validation
  chatRequestValidation,
  chatController.addFriend
);

app.delete(
  "/chat/user/:id/friend/:friendId",
  // üîí Security Layer: Rate limiting
  chatIPBlacklist,
  chatRateLimit,
  // ‚úÖ Session & Auth: Validate user session
  authCheckUser,
  chatSessionValidation,
  // üìä Monitoring: Audit logging and performance
  chatAuditLogging,
  chatPerformanceMonitoring,
  // üéØ Validation: Request validation
  chatRequestValidation,
  chatController.removeFriend
);

app.get(
  "/chat/user/:id/friends",
  // üîí Security Layer: Rate limiting
  chatIPBlacklist,
  chatRateLimit,
  // ‚úÖ Session & Auth: Validate user session
  authCheckUser,
  chatSessionValidation,
  // üõ°Ô∏è Privacy Protection: Check access permissions
  chatPrivacyProtection,
  // üìä Monitoring: Audit logging and performance
  chatAuditLogging,
  chatPerformanceMonitoring,
  // üéØ Validation: Request validation
  chatRequestValidation,
  chatController.getFriends
);

// Chat search and stats
app.get(
  "/chat/search",
  // üîí Security Layer: Rate limiting, flood prevention
  chatIPBlacklist,
  chatRateLimit,
  chatFloodPrevention,
  // ‚úÖ Session & Auth: Validate user session
  authCheckUser,
  chatSessionValidation,
  // üìä Monitoring: Audit logging and performance
  chatAuditLogging,
  chatPerformanceMonitoring,
  // üéØ Validation: Request validation
  chatRequestValidation,
  chatController.searchChatUsers
);

app.get(
  "/chat/stats/status",
  // üîí Security Layer: Rate limiting
  chatIPBlacklist,
  chatRateLimit,
  // ‚úÖ Session & Auth: Validate admin session
  authCheckAdmin,
  chatSessionValidation,
  // üìä Monitoring: Audit logging and performance
  chatAuditLogging,
  chatPerformanceMonitoring,
  chatController.getStatusStats
);

// Admin - Get all chat users
app.get(
  "/chat/users",
  // üîí Security Layer: Rate limiting
  chatIPBlacklist,
  chatRateLimit,
  // ‚úÖ Session & Auth: Validate admin session
  authCheckAdmin,
  chatSessionValidation,
  // üìä Monitoring: Audit logging and performance
  chatAuditLogging,
  chatPerformanceMonitoring,
  chatController.getAllChatUsers
);

// =====================================================================================
// FACE RECOGNITION ROUTES - B·∫£o m·∫≠t c·∫•p ƒë·ªô 5 v·ªõi 2FA
// =====================================================================================

// Import faceID routes v·ªõi b·∫£o m·∫≠t cao c·∫•p
const faceIDRoutes = require("./routes/faceID");

// √Åp d·ª•ng faceID routes v·ªõi b·∫£o m·∫≠t ƒë·∫∑c bi·ªát
app.use("/api/faceID", faceIDRoutes);

// =====================================================================================
// EVENT ROUTES (TODO)
// =====================================================================================

app.get(
  "/event",
  authCheckUser,
  // TODO: Implement event controller
  (req, res) =>
    res.render("events", {
      title: "Events",
      currentUser: req.user,
      events: [], // TODO: Add real events
    })
);

// =====================================================================================
// ERROR HANDLING MIDDLEWARE (ph·∫£i ƒë·∫∑t cu·ªëi)
// =====================================================================================

// 404 handler
app.use(require("./middlewares/errorHandler").errorHandler404);

// Global error handler
app.use(errorHandlerGlobal);

// =====================================================================================
// SERVER INITIALIZATION
// =====================================================================================

/**
 * Kh·ªüi ƒë·ªông server
 */
async function startServer() {
  try {
    // K·∫øt n·ªëi database
    await connectDB();

    // Kh·ªüi ƒë·ªông server
    server.listen(PORT, () => {
      console.log(`üöÄ Server ƒëang ch·∫°y tr√™n port ${PORT}`);
      console.log(`üìù Environment: ${NODE_ENV}`);
      console.log(`üîó URL: http://localhost:${PORT}`);

      if (NODE_ENV === "development") {
        console.log(`üìä API Docs: http://localhost:${PORT}/api`);
      }
    });

    // Graceful shutdown
    process.on("SIGTERM", gracefulShutdown);
    process.on("SIGINT", gracefulShutdown);

    function gracefulShutdown(signal) {
      console.log(`üì¥ Nh·∫≠n t√≠n hi·ªáu ${signal}. ƒêang t·∫Øt server...`);

      server.close(async () => {
        console.log("üõë Server ƒë√£ t·∫Øt");

        // ƒê√≥ng k·∫øt n·ªëi database
        await mongoose.connection.close();

        process.exit(0);
      });

      // Force close after 10 seconds
      setTimeout(() => {
        console.error("‚ùå Force shutdown after timeout");
        process.exit(1);
      }, 10000);
    }
  } catch (error) {
    console.error("‚ùå L·ªói kh·ªüi ƒë·ªông server:", error);
    process.exit(1);
  }
}

// Kh·ªüi ƒë·ªông server
startServer();

module.exports = app;
